#!/bin/bash

export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/sbin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"

function shutdown() {
    colima stop
    exit 0
}

trap shutdown SIGTERM
trap shutdown SIGKILL
trap shutdown SIGINT

echo checking
if ! colima status &>/dev/null; then
echo starting
# reason for dns: https://github.com/lima-vm/lima/issues/1333
# this might also work: --dns 192.168.5.3 per: https://github.com/lima-vm/lima/blob/master/docs/network.md#dns-19216853
    colima start --mount-type virtiofs --vm-type vz --memory 4 --dns 1.1.1.1 --ssh-config=false
fi
echo waiting
# wait until colima is running
until colima status &>/dev/null; do
    sleep 5
done

tail -f ~/.lima/colima/*.log &
wait -n $! $(cat ~/.lima/colima/vz.pid)
